name: Create Grafana Dashboards

on:
  push:
    branches: [ main, develop ]
    paths:
      - 'grafana_dashboards_scripts/**'
      - 'grafana/dashboards/**'
  workflow_dispatch:
    inputs:
      grafana_url:
        description: 'Grafana URL'
        required: true
        default: 'http://localhost:3000'

jobs:
  create-dashboards:
    name: Create All Grafana Dashboards
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v5
      with:
        python-version: '3.12'
        
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests python-dotenv
        
    - name: Wait for Grafana to be ready
      run: |
        echo "Waiting for Grafana..."
        timeout 60 bash -c 'until curl -sf ${{ github.event.inputs.grafana_url || secrets.GRAFANA_URL }}/api/health; do sleep 2; done' || true
        
    - name: Create dashboards
      env:
        GRAFANA_URL: ${{ github.event.inputs.grafana_url || secrets.GRAFANA_URL }}
        GRAFANA_USER: ${{ secrets.GRAFANA_USER }}
        GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
      run: |
        python run_all_dashboards.py
        
    - name: Verify dashboards
      env:
        GRAFANA_URL: ${{ github.event.inputs.grafana_url || secrets.GRAFANA_URL }}
        GRAFANA_USER: ${{ secrets.GRAFANA_USER }}
        GRAFANA_PASSWORD: ${{ secrets.GRAFANA_PASSWORD }}
      run: |
        curl -u $GRAFANA_USER:$GRAFANA_PASSWORD \
          $GRAFANA_URL/api/search?type=dash-db | jq '.'
